name: Daily Tech Digest

# ============================
# Secrets é…ç½®è¯´æ˜
# ============================
# åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ Secrets:
#
# 1. ANTHROPIC_API_KEY
#    - SiliconFlow API Keyï¼ˆAnthropic å…¼å®¹æ ¼å¼ï¼‰
#    - è·å–åœ°å€: https://siliconflow.cn/
#
# 2. ANTHROPIC_BASE_URL (å¯é€‰)
#    - API ç«¯ç‚¹åœ°å€ï¼Œé»˜è®¤ä½¿ç”¨ SiliconFlow: https://api.siliconflow.cn/v1
# ============================

on:
  schedule:
    # æ¯å¤© UTC 00:00 è¿è¡Œ = åŒ—äº¬æ—¶é—´ 8:00
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate-digest:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          uv pip install -r requirements.txt

      - name: Generate digest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        run: |
          echo "ç”Ÿæˆ Daily Tech News..."
          python scripts/tech_digest.py

      - name: Generate HTML pages
        run: |
          python scripts/generate_page.py
          python scripts/generate_html.py

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–°çš„ç®€æŠ¥ç”Ÿæˆ"
            exit 0
          fi

          # è·å–æ—¥æœŸ
          DATE=$(TZ='Asia/Shanghai' date +%Y-%m-%d)

          # æäº¤å˜æ›´
          git add digests/ index.html
          git commit -m "ğŸ“° Daily digest: ${DATE}"
          git push

      # Telegram é€šçŸ¥ï¼ˆæš‚æœªå¯ç”¨ï¼‰
      # - name: Send Telegram notification
      #   if: success()
      #   env:
      #     TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      #     TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      #   run: |
      #     DATE=$(TZ='Asia/Shanghai' date +%Y-%m-%d)
      #     MESSAGE="ğŸ“° æ¯æ—¥ç§‘æŠ€ç®€æŠ¥å·²æ›´æ–°: ${DATE}"
      #     curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
      #       -d chat_id="${TELEGRAM_CHAT_ID}" \
      #       -d text="${MESSAGE}" \
      #       -d parse_mode="Markdown"
